# YouYou é¡¹ç›®ä¸šåŠ¡é€»è¾‘å…¨é¢åˆ†æ

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒä¸šåŠ¡æµç¨‹](#æ ¸å¿ƒä¸šåŠ¡æµç¨‹)
3. [æ•°æ®æµåˆ†æ](#æ•°æ®æµåˆ†æ)
4. [å…³é”®ç»„ä»¶è¯¦è§£](#å…³é”®ç»„ä»¶è¯¦è§£)
5. [ä¸šåŠ¡åœºæ™¯åˆ†æ](#ä¸šåŠ¡åœºæ™¯åˆ†æ)
6. [è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†](#è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†)
7. [æ€§èƒ½å’Œä¼˜åŒ–](#æ€§èƒ½å’Œä¼˜åŒ–)
8. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·äº¤äº’å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   CLI å®¢æˆ·ç«¯   â”‚â—„â”€â”€â”€â”€HTTPâ”€â”€â”€â”€â–ºâ”‚  Flask æœåŠ¡ç«¯  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Agent åè°ƒå±‚        â”‚                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                     â”‚
â”‚                    â”‚ Supervisor Agent â”‚â—„â”€â”˜                     â”‚
â”‚                    â”‚  (è·¯ç”±å†³ç­–)        â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                             â”‚                                 â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚              â–¼                             â–¼                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚    â”‚  ItemAgent       â”‚           â”‚  ChatAgent       â”‚         â”‚
â”‚    â”‚  (ç‰©å“ç®¡ç†)       â”‚           â”‚  (é€šç”¨å¯¹è¯)       â”‚         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å­˜å‚¨å±‚â”‚                                               â”‚
â”‚              â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   SQLite Database    â”‚    â”‚   Zep Memory (å¯é€‰)    â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚
â”‚  â”‚  â”‚ items è¡¨       â”‚  â”‚    â”‚  â”‚  Thread/Sessionâ”‚  â”‚        â”‚
â”‚  â”‚  â”‚ item_historyè¡¨ â”‚  â”‚    â”‚  â”‚  Messages      â”‚  â”‚        â”‚
â”‚  â”‚  â”‚ items_ftsè¡¨    â”‚  â”‚    â”‚  â”‚  Facts         â”‚  â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚        Session History Manager (å†…å­˜ç¼“å­˜)         â”‚        â”‚
â”‚  â”‚  - å†…å­˜çº§ä¼šè¯å†å²                                  â”‚        â”‚
â”‚  â”‚  - é¦–æ¬¡ä» Zep åŠ è½½                                 â”‚        â”‚
â”‚  â”‚  - å¼‚æ­¥æŒä¹…åŒ–åˆ° Zep                                â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: LangChain 1.0, Flask, Flask-RESTX
- **æ•°æ®åº“**: SQLite (FTS5 å…¨æ–‡æœç´¢)
- **è®°å¿†ç³»ç»Ÿ**: Zep Cloud 3.0 / æœ¬åœ° Zep
- **AI æ¨¡å‹**: å…¼å®¹ OpenAI API çš„æ¨¡å‹(å¦‚ DeepSeek, SiliconFlow)
- **å·¥å…·**: prompt-toolkit, rich (CLI), requests

---

## æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. è¯·æ±‚å¤„ç†æ€»æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ Flask API â†’ Session History â†’ Supervisor â†’ Sub-Agent â†’ å·¥å…·è°ƒç”¨ â†’ å“åº”
                            â†“                                          â†“
                       Zep Memory (å¼‚æ­¥)                         Database/Zep
```

#### è¯¦ç»†æ­¥éª¤

1. **æ¥æ”¶è¯·æ±‚** (`server.py: /api/v1/chat/message`)
   - éªŒè¯æ¶ˆæ¯éç©º
   - è·å–ç”¨æˆ·ID (config.USER_ID)

2. **åŠ è½½ä¼šè¯å†å²** (`session_history.py`)
   - é¦–æ¬¡è®¿é—®: ä» Zep åŠ è½½å†å²
   - åç»­è®¿é—®: ä½¿ç”¨å†…å­˜ç¼“å­˜
   - æ„å»ºå®Œæ•´æ¶ˆæ¯åˆ—è¡¨: `history + [current_message]`

3. **è°ƒç”¨ Supervisor** (`agents/supervisor/agent.py`)
   - æ¥æ”¶å®Œæ•´æ¶ˆæ¯åˆ—è¡¨(åŒ…å«å†å²)
   - ä½¿ç”¨ ROUTER_MODEL è¿›è¡Œæ„å›¾è¯†åˆ«
   - å†³å®šè°ƒç”¨å“ªä¸ªå­ Agent

4. **è·¯ç”±å†³ç­–** (åŸºäºæç¤ºè¯è§„åˆ™)
   - åŒ…å«å…³é”®è¯("åœ¨", "æ”¾", "ä½ç½®", "å“ªé‡Œ", "å“ªå„¿") â†’ ItemAgent
   - å…¶ä»–æƒ…å†µ â†’ ChatAgent
   - **é‡è¦**: åŸå°ä¸åŠ¨ä¼ é€’ç”¨æˆ·æ¶ˆæ¯,ä¸ä¿®æ”¹

5. **å­ Agent å¤„ç†**
   - **ItemAgent**: è°ƒç”¨ç‰©å“ç®¡ç†å·¥å…·
   - **ChatAgent**: ç›´æ¥å¯¹è¯å“åº”

6. **æå–å“åº”**
   - ä» LangChain result ä¸­æå–æœ€åä¸€æ¡æ¶ˆæ¯
   - è¿”å›ç»™ç”¨æˆ·

7. **æŒä¹…åŒ–** (å¼‚æ­¥)
   - ç«‹å³å†™å…¥å†…å­˜ç¼“å­˜
   - å¼‚æ­¥å†™å…¥ Zep (ä¸é˜»å¡å“åº”)

### 2. ç‰©å“è®°å½•æµç¨‹ (ItemAgent)

```
ç”¨æˆ·è¾“å…¥: "é’¥åŒ™åœ¨æ¡Œä¸Š"
    â†“
Supervisor è·¯ç”±åˆ° ItemAgent
    â†“
ItemAgent è§£æå‚æ•°
    â”œâ”€ item: "é’¥åŒ™"
    â””â”€ location: "æ¡Œä¸Š"
    â†“
è°ƒç”¨ remember_item_location(item, location)
    â†“
æ•°æ®åº“å±‚ (database.py)
    â”œâ”€ è§„èŒƒåŒ–ç‰©å“åç§°: normalize_item_name("é’¥åŒ™") â†’ "é’¥åŒ™"
    â”œâ”€ æå–åˆ«å: extract_aliases("é’¥åŒ™") â†’ ["é’¥åŒ™", "key"]
    â”œâ”€ æ£€æŸ¥æ˜¯å¦å­˜åœ¨ (normalized_name)
    â”‚   â”œâ”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°è®°å½• (action: created)
    â”‚   â”œâ”€ å­˜åœ¨ä¸”ä½ç½®ç›¸åŒ â†’ æ›´æ–°è®¿é—®æ—¶é—´ (action: confirmed)
    â”‚   â””â”€ å­˜åœ¨ä½†ä½ç½®ä¸åŒ â†’ æ›´æ–°ä½ç½® + è®°å½•å†å² (action: moved)
    â””â”€ è‡ªåŠ¨åŒæ­¥åˆ° items_fts (FTS5 è§¦å‘å™¨)
    â†“
è¿”å›ç»“æœ: "å·²è®°ä½: é’¥åŒ™åœ¨æ¡Œä¸Š"
```

#### æ•°æ®åº“è¡¨è®¾è®¡

**items è¡¨** (ä¸»è¡¨)
```sql
- id: ä¸»é”®
- item_name: åŸå§‹åç§° (å¦‚ "é’¥åŒ™")
- normalized_name: è§„èŒƒåŒ–åç§° (å¦‚ "é’¥åŒ™", ç”¨äºç²¾ç¡®åŒ¹é…)
- item_aliases: JSON æ•°ç»„ (å¦‚ ["é’¥åŒ™", "key"])
- location: ä½ç½®
- user_id: ç”¨æˆ·ID
- created_at, updated_at, moved_at: æ—¶é—´æˆ³
- move_count, query_count: ç»Ÿè®¡ä¿¡æ¯
- is_deleted, is_active: çŠ¶æ€æ ‡è®°
```

**item_history è¡¨** (å†å²è®°å½•)
```sql
- id: ä¸»é”®
- item_id: å…³è” items.id
- action: æ“ä½œç±»å‹ (create/move/update)
- old_value, new_value: å˜æ›´å†…å®¹
- timestamp: æ—¶é—´æˆ³
```

**items_fts è¡¨** (FTS5 å…¨æ–‡æœç´¢)
```sql
- è™šæ‹Ÿè¡¨,è‡ªåŠ¨åŒæ­¥ items è¡¨å†…å®¹
- æ”¯æŒä¸­æ–‡å…¨æ–‡æœç´¢
- é€šè¿‡è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°
```

### 3. ç‰©å“æŸ¥è¯¢æµç¨‹ (äº”çº§ç­–ç•¥)

```
ç”¨æˆ·è¾“å…¥: "é’¥åŒ™åœ¨å“ª?"
    â†“
Supervisor è·¯ç”±åˆ° ItemAgent
    â†“
ItemAgent è§£æå‚æ•°
    â””â”€ item: "é’¥åŒ™"
    â†“
è°ƒç”¨ query_item_location(item)
    â†“
æ•°æ®åº“æŸ¥è¯¢ (äº”çº§ç­–ç•¥)
    â”‚
    â”œâ”€ Level 1: ç²¾ç¡®åŒ¹é… (normalized_name = "é’¥åŒ™")
    â”‚   SELECT * FROM items WHERE normalized_name = ?
    â”‚   âœ“ æ‰¾åˆ° â†’ è¿”å› (match_type: exact)
    â”‚   âœ— æœªæ‰¾åˆ° â†’ ç»§ç»­ Level 2
    â”‚
    â”œâ”€ Level 2: åˆ«ååŒ¹é… (item_aliases LIKE "%é’¥åŒ™%")
    â”‚   SELECT * FROM items WHERE item_aliases LIKE ?
    â”‚   + éªŒè¯: _verify_item_name() é˜²æ­¢è¯¯åŒ¹é…
    â”‚   âœ“ æ‰¾åˆ°ä¸”éªŒè¯é€šè¿‡ â†’ è¿”å› (match_type: alias)
    â”‚   âœ— æœªæ‰¾åˆ° â†’ ç»§ç»­ Level 3
    â”‚
    â”œâ”€ Level 3: FTS5 å…¨æ–‡æœç´¢
    â”‚   SELECT * FROM items_fts WHERE items_fts MATCH ?
    â”‚   + éªŒè¯: _verify_item_name()
    â”‚   âœ“ æ‰¾åˆ°ä¸”éªŒè¯é€šè¿‡ â†’ è¿”å› (match_type: fuzzy)
    â”‚   âœ— æœªæ‰¾åˆ° â†’ ç»§ç»­ Level 4
    â”‚
    â”œâ”€ Level 4: å…³é”®è¯æ¨¡ç³ŠåŒ¹é… (LIKE)
    â”‚   æå–å…³é”®è¯: extract_keywords("é’¥åŒ™") â†’ ["é’¥åŒ™"]
    â”‚   SELECT * FROM items WHERE item_name LIKE "%é’¥åŒ™%"
    â”‚   + è®¡ç®—åŒ¹é…åº¦: åŒ¹é…çš„å…³é”®è¯æ•°é‡
    â”‚   âœ“ æ‰¾åˆ° â†’ è¿”å› (match_type: keyword_fuzzy)
    â”‚   âœ— æœªæ‰¾åˆ° â†’ ç»§ç»­ Level 5
    â”‚
    â””â”€ Level 5: Zep è¯­ä¹‰æœç´¢å…œåº• (å¯é€‰)
        Zep.search_memory(query="ç”¨æˆ·æåˆ° é’¥åŒ™ çš„ä½ç½®")
        + è¯­ä¹‰åŒ¹é…å†å²å¯¹è¯
        âœ“ æ‰¾åˆ°ç›¸å…³å¯¹è¯ â†’ è¿”å›ä¸Šä¸‹æ–‡ (match_type: zep_semantic)
        âœ— æœªæ‰¾åˆ° â†’ è¿”å› not_found
```

#### å…³é”®è¯æå–ç®—æ³• (`extract_keywords`)

```python
è¾“å…¥: "æ‘©æ‰˜è½¦é’¥åŒ™"
    â†“
1. è§„èŒƒåŒ–: "æ‘©æ‰˜è½¦é’¥åŒ™"
2. ç§»é™¤åœç”¨è¯: ['çš„', 'äº†', 'åœ¨', 'æ˜¯', ...]
3. æŒ‰ç©ºæ ¼åˆ†å‰²: ["æ‘©æ‰˜è½¦é’¥åŒ™"]
4. æå–å­ä¸² (2-4å­—):
   - "æ‘©æ‰˜è½¦"
   - "æ‰˜è½¦"
   - "è½¦é’¥"
   - "é’¥åŒ™"
5. å»é‡å¹¶æŒ‰é•¿åº¦æ’åº
    â†“
è¾“å‡º: ["æ‘©æ‰˜è½¦é’¥åŒ™", "æ‘©æ‰˜è½¦", "é’¥åŒ™", "æ‰˜è½¦", "è½¦é’¥"]
```

#### ç‰©å“åç§°éªŒè¯ (`_verify_item_name`)

é˜²æ­¢è®°å¿†æ··æ·†,ç¡®ä¿æŸ¥è¯¢ç»“æœç¡®å®åŒ¹é…ç”¨æˆ·æŸ¥è¯¢:

```python
def _verify_item_name(result, query_item):
    """éªŒè¯æŸ¥è¯¢ç»“æœæ˜¯å¦çœŸçš„åŒ¹é…

    ç­–ç•¥:
    1. æŸ¥è¯¢è¯åœ¨ç‰©å“åç§°ä¸­: "é’¥åŒ™" in "æ‘©æ‰˜è½¦é’¥åŒ™" âœ“
    2. ç‰©å“åç§°åœ¨æŸ¥è¯¢è¯ä¸­: "é’¥åŒ™" in "å®¶é—¨é’¥åŒ™" âœ“
    3. è§„èŒƒåŒ–ååŒ¹é…
    4. æ£€æŸ¥åˆ«å

    é˜²æ­¢é”™è¯¯åŒ¹é…:
    - æŸ¥è¯¢"æŠ¤ç…§" ä¸åº”åŒ¹é… "æ‹¨ç…§"
    - æŸ¥è¯¢"æ—¶å…‰æœº" ä¸åº”åŒ¹é… "æŠ¤ç…§"
    """
```

### 4. ä¼šè¯å†å²ç®¡ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Session History Manager                   â”‚
â”‚                     (å†…å­˜ + Zep åŒå±‚æ¶æ„)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é¦–æ¬¡è¯·æ±‚:
    â†“
1. get_history(user_id) è¢«è°ƒç”¨
    â”œâ”€ æ£€æŸ¥å†…å­˜ç¼“å­˜: _histories[user_id]
    â”œâ”€ æœªæ‰¾åˆ° â†’ ä» Zep åŠ è½½
    â”‚   â””â”€ zep.get_recent_context(limit=20)
    â”œâ”€ å­˜å…¥å†…å­˜ç¼“å­˜
    â””â”€ è¿”å›å†å²æ¶ˆæ¯åˆ—è¡¨

2. Supervisor ä½¿ç”¨å†å² + å½“å‰æ¶ˆæ¯å¤„ç†è¯·æ±‚

3. add_interaction() è¢«è°ƒç”¨
    â”œâ”€ ç«‹å³å†™å…¥å†…å­˜ç¼“å­˜ (åŒæ­¥)
    â”‚   â””â”€ append [user_msg, assistant_msg]
    â”‚   â””â”€ è£å‰ªåˆ° max_length (é»˜è®¤ 10 è½® = 20 æ¡æ¶ˆæ¯)
    â””â”€ å¼‚æ­¥æŒä¹…åŒ–åˆ° Zep (ä¸é˜»å¡)
        â””â”€ Thread(target=zep.add_interaction)

åç»­è¯·æ±‚:
    â”œâ”€ get_history() ç›´æ¥ä»å†…å­˜è¿”å› (å¿«é€Ÿ)
    â”œâ”€ å¯é€‰: å®šæœŸåˆ·æ–° (refresh_interval)
    â””â”€ ç»§ç»­å¼‚æ­¥æŒä¹…åŒ–
```

#### å†…å­˜ç¼“å­˜è®¾è®¡

```python
class SessionHistoryManager:
    _histories: Dict[str, List[Dict]]  # {user_id: [messages]}
    _last_refresh: Dict[str, float]    # {user_id: timestamp}
    _max_length: int = 10              # æœ€å¤§å†å²è½®æ•°
    _refresh_interval: int = 300       # åˆ·æ–°é—´éš”(ç§’)
```

**ä¼˜ç‚¹**:
- å‡å°‘ Zep è¿œç¨‹è°ƒç”¨,æå‡å“åº”é€Ÿåº¦
- å¼‚æ­¥æŒä¹…åŒ–,ä¸é˜»å¡ç”¨æˆ·å“åº”
- è‡ªåŠ¨è£å‰ª,æ§åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦

**ç¼“å­˜ç­–ç•¥**:
- é¦–æ¬¡è®¿é—®: ä» Zep åŠ è½½
- åç»­è®¿é—®: å†…å­˜è¿”å›
- å®šæœŸåˆ·æ–°: å¯é…ç½® (é»˜è®¤ 5 åˆ†é’Ÿ)
- å¼‚æ­¥å†™å…¥: ä¸å½±å“å“åº”æ—¶é—´

### 5. Zep è®°å¿†ç³»ç»Ÿ (å…¨å±€è®°å¿†ä¸­æ¢)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Zep Memory Manager                       â”‚
â”‚              (ä½œä¸ºç³»ç»Ÿçš„æœ€é¡¶å±‚è®°å¿†ä¸­æ¢)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ ¸å¿ƒåŠŸèƒ½:
1. add_interaction(user_input, assistant_response)
   - è®°å½•å®Œæ•´å¯¹è¯äº¤äº’
   - è‡ªåŠ¨ç”Ÿæˆ facts å’Œ summary

2. search_memory(query, limit=5)
   - è¯­ä¹‰æœç´¢å†å²å¯¹è¯
   - ä½œä¸ºæ•°æ®åº“æŸ¥è¯¢çš„å…œåº•æ–¹æ¡ˆ

3. get_recent_context(limit=10)
   - è·å–æœ€è¿‘çš„å¯¹è¯å†å²
   - ç”¨äº Session History çš„åˆå§‹åŠ è½½

4. get_session_summary()
   - è·å– Zep è‡ªåŠ¨ç”Ÿæˆçš„ä¼šè¯æ‘˜è¦

5. extract_facts()
   - æå– Zep è‡ªåŠ¨è¯†åˆ«çš„äº‹å®
```

#### Zep å…œåº•æœç´¢æµç¨‹

```
ç”¨æˆ·æŸ¥è¯¢: "æ—¶å…‰æœºåœ¨å“ª?"
    â†“
æ•°æ®åº“æŸ¥è¯¢ Level 1-4 å…¨éƒ¨å¤±è´¥
    â†“
è§¦å‘ Level 5: Zep è¯­ä¹‰æœç´¢
    â†“
zep.search_memory(query="ç”¨æˆ·æåˆ° æ—¶å…‰æœº çš„ä½ç½®ã€å­˜æ”¾ä½ç½®ã€æ”¾åœ¨å“ªé‡Œ")
    â†“
Zep è¿”å›ç›¸å…³å¯¹è¯ç‰‡æ®µ:
    - "æˆ‘ä¹‹å‰æåˆ°æ—¶å…‰æœºæ”¾åœ¨å®éªŒå®¤"
    - score: 0.85
    â†“
è¿”å›: "åœ¨å†å²å¯¹è¯ä¸­æ‰¾åˆ°ç›¸å…³ä¿¡æ¯: æˆ‘ä¹‹å‰æåˆ°æ—¶å…‰æœºæ”¾åœ¨å®éªŒå®¤"
(match_type: zep_semantic, confidence: low)
```

---

## æ•°æ®æµåˆ†æ

### è¯·æ±‚æ•°æ®æµ

```
1. HTTP Request
   POST /api/v1/chat/message
   Body: {"message": "é’¥åŒ™åœ¨å“ª?"}

2. Flask Handler (server.py)
   â”œâ”€ éªŒè¯æ¶ˆæ¯
   â”œâ”€ è·å– user_id
   â””â”€ åŠ è½½ä¼šè¯å†å²

3. Supervisor Invocation
   Input: {
     "messages": [
       {"role": "user", "content": "ä½ å¥½"},           # å†å²
       {"role": "assistant", "content": "ä½ å¥½!"},     # å†å²
       {"role": "user", "content": "é’¥åŒ™åœ¨å“ª?"}       # å½“å‰
     ]
   }

4. Supervisor Routing
   - åˆ†ææ¶ˆæ¯: "é’¥åŒ™åœ¨å“ª?" â†’ åŒ…å«"å“ª"
   - å†³ç­–: è°ƒç”¨ item_agent_tool
   - ä¼ é€’: query="é’¥åŒ™åœ¨å“ª?" (åŸå§‹æ¶ˆæ¯)

5. ItemAgent Processing
   - è§£æå‚æ•°: item="é’¥åŒ™"
   - è°ƒç”¨å·¥å…·: query_item_location(item)

6. Database Query (äº”çº§ç­–ç•¥)
   Level 1 â†’ Level 2 â†’ ... â†’ æ‰¾åˆ°ç»“æœ

7. Tool Result
   Return: "é’¥åŒ™åœ¨æ¡Œä¸Š"

8. LangChain Result
   Output: {
     "messages": [
       # ... æ‰€æœ‰å†å²æ¶ˆæ¯ ...
       ToolMessage(content="é’¥åŒ™åœ¨æ¡Œä¸Š"),
       AIMessage(content="é’¥åŒ™åœ¨æ¡Œä¸Š")
     ]
   }

9. Extract Response
   - å€’åºæŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰å†…å®¹çš„æ¶ˆæ¯
   - response = "é’¥åŒ™åœ¨æ¡Œä¸Š"

10. Persist History
    â”œâ”€ åŒæ­¥: å†™å…¥å†…å­˜ç¼“å­˜
    â””â”€ å¼‚æ­¥: æŒä¹…åŒ–åˆ° Zep

11. HTTP Response
    {
      "response": "é’¥åŒ™åœ¨æ¡Œä¸Š",
      "timestamp": "2025-11-06T12:00:00"
    }
```

### æ•°æ®æŒä¹…åŒ–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å†™å…¥è·¯å¾„                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰©å“è®°å½•:
  User Input â†’ ItemAgent â†’ remember_item_location()
      â†“
  SQLite (items è¡¨)
      â”œâ”€ ä¸»è¡¨: items
      â”œâ”€ å†å²: item_history
      â””â”€ FTS5: items_fts (è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥)

ä¼šè¯å†å²:
  User Input + Assistant Response
      â†“
  Session History Manager
      â”œâ”€ ç«‹å³å†™å…¥: å†…å­˜ç¼“å­˜ (_histories)
      â””â”€ å¼‚æ­¥å†™å…¥: Zep Memory
          â””â”€ Thread â†’ zep.add_interaction()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯»å–è·¯å¾„                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰©å“æŸ¥è¯¢:
  User Query â†’ ItemAgent â†’ query_item_location()
      â†“
  SQLite (äº”çº§æŸ¥è¯¢)
      â”œâ”€ Level 1-4: æ•°æ®åº“æŸ¥è¯¢
      â””â”€ Level 5: Zep è¯­ä¹‰æœç´¢

ä¼šè¯å†å²:
  Request Start â†’ get_history(user_id)
      â†“
  Session History Manager
      â”œâ”€ é¦–æ¬¡: ä» Zep åŠ è½½ â†’ å­˜å…¥å†…å­˜
      â””â”€ åç»­: ç›´æ¥ä»å†…å­˜è¿”å›
```

---

## å…³é”®ç»„ä»¶è¯¦è§£

### 1. Supervisor Agent

**èŒè´£**: æ„å›¾è¯†åˆ«å’Œè·¯ç”±å†³ç­–

**æ ¸å¿ƒé€»è¾‘** (`agents/supervisor/prompts.py`):
```python
è·¯ç”±è§„åˆ™:
- åŒ…å«å…³é”®è¯ ("åœ¨", "æ”¾", "ä½ç½®", "å“ªé‡Œ", "å“ªå„¿") â†’ item_agent_tool
- å…¶ä»–æ‰€æœ‰æƒ…å†µ â†’ chat_agent_tool

é‡è¦çº¦æŸ:
- å¿…é¡»åŸå°ä¸åŠ¨ä¼ é€’ç”¨æˆ·æ¶ˆæ¯
- ç¦æ­¢ä¿®æ”¹ã€è½¬å†™ã€ç¿»è¯‘ç”¨æˆ·æ–‡æœ¬
- ç¤ºä¾‹: "æŠ¤ç…§" ä¸èƒ½è½¬å†™ä¸º "æ‹¨ç…§"
```

**å®ç°** (`agents/supervisor/agent.py`):
```python
def create_supervisor():
    supervisor_model = ChatOpenAI(
        model=config.ROUTER_MODEL,
        temperature=0  # è·¯ç”±éœ€è¦ç¡®å®šæ€§
    )

    tools = AgentRegistry.get_all_tools()  # è‡ªåŠ¨è·å–å·²æ³¨å†Œçš„å­ Agent

    supervisor = create_agent(
        model=supervisor_model,
        tools=tools,
        system_prompt=SUPERVISOR_SYSTEM_PROMPT
    )

    return supervisor
```

**è‡ªåŠ¨æ³¨å†Œç³»ç»Ÿ** (`core/agent_base.py`):
```python
class AgentRegistry:
    _agents: Dict[str, AgentProtocol] = {}

    @classmethod
    def register(cls, agent: AgentProtocol):
        """å­ Agent åœ¨åˆå§‹åŒ–æ—¶è‡ªåŠ¨æ³¨å†Œ"""
        cls._agents[agent.name] = agent

    @classmethod
    def get_all_tools(cls):
        """Supervisor è‡ªåŠ¨è·å–æ‰€æœ‰å·¥å…·"""
        return [agent.as_tool() for agent in cls._agents.values()]
```

### 2. ItemAgent

**èŒè´£**: ç‰©å“ä½ç½®ç®¡ç†

**å·¥å…·åˆ—è¡¨** (`agents/item_agent/tools.py`):
1. `remember_item_location(item, location)` - è®°å½•ç‰©å“
2. `query_item_location(item)` - æŸ¥è¯¢ç‰©å“
3. `list_all_items()` - åˆ—å‡ºæ‰€æœ‰ç‰©å“

**å‚æ•°æå–è§„åˆ™** (`agents/item_agent/prompts.py`):
```python
ç¤ºä¾‹:
- "æŠ¤ç…§åœ¨å§å®¤ä¿é™©æŸœ" â†’ item="æŠ¤ç…§", location="å§å®¤ä¿é™©æŸœ"
- "æŠŠé’¥åŒ™æ”¾åœ¨æ¡Œä¸Š" â†’ item="é’¥åŒ™", location="æ¡Œä¸Š"
- "ç¬”è®°æœ¬ç”µè„‘åœ¨ä¹¦æˆ¿" â†’ item="ç¬”è®°æœ¬ç”µè„‘", location="ä¹¦æˆ¿"

ç¦æ­¢:
- âŒ "æŠ¤ç…§" â†’ "æ‹¨ç…§" (é”™è¯¯éŸ³è¯‘)
- âŒ "æŠ¤ç…§" â†’ "æŠ¥å‘Š" (é”™è¯¯ç†è§£)
```

**å®ç°** (`agents/item_agent/agent.py`):
```python
class ItemAgent(BaseAgent):
    def __init__(self):
        super().__init__(
            name="item_agent",
            description="å¤„ç†ç‰©å“ä½ç½®ç›¸å…³çš„è¯·æ±‚"
        )

        self.agent = create_agent(
            model=ChatOpenAI(...),
            tools=[remember_item_location, query_item_location, list_all_items],
            system_prompt=ITEM_SYSTEM_PROMPT
        )

    def invoke(self, query: str) -> str:
        result = self.agent.invoke({"messages": [{"role": "user", "content": query}]})
        return self._extract_response_from_result(result)

# è‡ªåŠ¨æ³¨å†Œ
item_agent = ItemAgent()
AgentRegistry.register(item_agent)
```

### 3. ChatAgent

**èŒè´£**: é€šç”¨å¯¹è¯å’Œé—®ç­”

**ç‰¹ç‚¹**:
- æ— éœ€å¤–éƒ¨å·¥å…·,çº¯å¯¹è¯èƒ½åŠ›
- ç†è§£ä¸Šä¸‹æ–‡å’Œä»£è¯å¼•ç”¨
- å‹å¥½ã€ç®€æ´çš„äº¤æµé£æ ¼

**å®ç°** (`agents/chat_agent/agent.py`):
```python
class ChatAgent(BaseAgent):
    def __init__(self):
        super().__init__(
            name="chat_agent",
            description="å¤„ç†ä¸€èˆ¬æ€§å¯¹è¯å’Œé—®é¢˜"
        )

        self.agent = create_agent(
            model=ChatOpenAI(temperature=0.7),  # å¯¹è¯å¯ä»¥æœ‰åˆ›é€ æ€§
            tools=[],  # æ— éœ€å·¥å…·
            system_prompt=CHAT_SYSTEM_PROMPT
        )

# è‡ªåŠ¨æ³¨å†Œ
chat_agent = ChatAgent()
AgentRegistry.register(chat_agent)
```

### 4. Database Manager

**èŒè´£**: SQLite æ•°æ®åº“æ“ä½œ

**æ ¸å¿ƒæ–¹æ³•**:
```python
class ItemDatabase:
    def remember_item(self, item, location, user_id):
        """è®°å½•ç‰©å“,å¤„ç†é‡å¤å’Œæ›´æ–°"""

    def query_item(self, item, user_id):
        """äº”çº§æŸ¥è¯¢ç­–ç•¥"""

    def list_all_items(self, user_id):
        """åˆ—å‡ºæ‰€æœ‰ç‰©å“"""

    def get_item_history(self, item, user_id):
        """è·å–å˜æ›´å†å²"""
```

**è¾…åŠ©å‡½æ•°**:
```python
def normalize_item_name(item: str) -> str:
    """è§„èŒƒåŒ–ç‰©å“åç§° (å°å†™ + å»æ ‡ç‚¹ + å‹ç¼©ç©ºæ ¼)"""

def extract_aliases(item: str) -> List[str]:
    """æå–åˆ«å (å¦‚ "ç¬”è®°æœ¬ç”µè„‘" â†’ ["ç”µè„‘", "ç¬”è®°æœ¬", "laptop"])"""

def extract_keywords(text: str) -> List[str]:
    """æå–å…³é”®è¯ (ç§»é™¤åœç”¨è¯ + å­ä¸²æå–)"""

def _verify_item_name(result, query_item) -> bool:
    """éªŒè¯æŸ¥è¯¢ç»“æœæ˜¯å¦åŒ¹é… (é˜²æ­¢è¯¯åŒ¹é…)"""
```

**çº¿ç¨‹å®‰å…¨**:
```python
class ItemDatabase:
    def __init__(self, db_path):
        self._lock = threading.RLock()  # é€’å½’é”
        self.conn = sqlite3.connect(
            db_path,
            check_same_thread=False,  # å…è®¸å¤šçº¿ç¨‹
            isolation_level=None,      # autocommit
            timeout=30.0               # é”å®šè¶…æ—¶
        )
        self.conn.execute("PRAGMA journal_mode=WAL")  # WAL æ¨¡å¼æ”¯æŒå¹¶å‘
```

### 5. Zep Memory Manager

**èŒè´£**: å…¨å±€è®°å¿†ä¸­æ¢

**å…³é”®æ–¹æ³•**:
```python
class ZepMemoryManager:
    def add_interaction(self, user_input, assistant_response, agent_name):
        """è®°å½•å®Œæ•´äº¤äº’"""

    def search_memory(self, query, limit=5):
        """è¯­ä¹‰æœç´¢ (å…œåº•æ–¹æ¡ˆ)"""

    def get_recent_context(self, limit=10):
        """è·å–æœ€è¿‘å¯¹è¯"""

    def extract_facts(self):
        """æå–äº‹å®"""
```

**Zep 3.0 API é€‚é…**:
```python
if config.ZEP_API_KEY:
    # Zep Cloud 3.0
    from zep_cloud import Zep, Message
    client = Zep(api_key=config.ZEP_API_KEY)
    client.thread.add_messages(thread_id, messages=[...])
else:
    # æœ¬åœ° Zep
    from zep_python import ZepClient, Message
    client = ZepClient(base_url=config.ZEP_API_URL)
    client.memory.add_memory(session_id, messages=[...])
```

### 6. Session History Manager

**èŒè´£**: å†…å­˜çº§ä¼šè¯ç¼“å­˜

**æ ¸å¿ƒè®¾è®¡**:
```python
class SessionHistoryManager:
    _histories: Dict[str, List[Dict]]  # å†…å­˜ç¼“å­˜
    _last_refresh: Dict[str, float]    # åˆ·æ–°æ—¶é—´æˆ³

    def get_history(self, user_id, force_refresh=False):
        """è·å–å†å² (å†…å­˜ä¼˜å…ˆ)"""
        if should_load:
            # ä» Zep åŠ è½½
            messages = zep.get_recent_context()
            self._histories[user_id] = messages
        return self._histories[user_id].copy()

    def add_interaction(self, user_id, user_input, assistant_response, async_persist=True):
        """æ·»åŠ äº¤äº’ (åŒæ­¥å†…å­˜ + å¼‚æ­¥ Zep)"""
        # ç«‹å³å†™å…¥å†…å­˜
        self._histories[user_id].append(...)

        # è£å‰ªåˆ°æœ€å¤§é•¿åº¦
        if len(self._histories[user_id]) > max_messages:
            self._histories[user_id] = self._histories[user_id][-max_messages:]

        # å¼‚æ­¥æŒä¹…åŒ–
        if async_persist:
            Thread(target=_persist, daemon=True).start()
```

---

## ä¸šåŠ¡åœºæ™¯åˆ†æ

### åœºæ™¯ 1: è®°å½•æ–°ç‰©å“

**ç”¨æˆ·è¾“å…¥**: "é’¥åŒ™åœ¨æ¡Œä¸Š"

**æ‰§è¡Œæµç¨‹**:
1. Supervisor è¯†åˆ«å…³é”®è¯"åœ¨" â†’ è·¯ç”±åˆ° ItemAgent
2. ItemAgent è§£æ: item="é’¥åŒ™", location="æ¡Œä¸Š"
3. æ•°æ®åº“æ£€æŸ¥: normalized_name="é’¥åŒ™" ä¸å­˜åœ¨
4. åˆ›å»ºæ–°è®°å½•:
   - item_name = "é’¥åŒ™"
   - normalized_name = "é’¥åŒ™"
   - item_aliases = ["é’¥åŒ™", "key"]
   - location = "æ¡Œä¸Š"
   - created_at = now()
5. è®°å½•å†å²: action="create"
6. è¿”å›: "å·²è®°ä½: é’¥åŒ™åœ¨æ¡Œä¸Š"

**æ•°æ®åº“çŠ¶æ€**:
```
items è¡¨:
| id | item_name | normalized_name | location | move_count |
|----|-----------|-----------------|----------|------------|
| 1  | é’¥åŒ™      | é’¥åŒ™             | æ¡Œä¸Š     | 0          |

item_history è¡¨:
| id | item_id | action | new_value |
|----|---------|--------|-----------|
| 1  | 1       | create | æ¡Œä¸Š      |
```

### åœºæ™¯ 2: æŸ¥è¯¢ç‰©å“ (ç²¾ç¡®åŒ¹é…)

**ç”¨æˆ·è¾“å…¥**: "é’¥åŒ™åœ¨å“ªï¼Ÿ"

**æ‰§è¡Œæµç¨‹**:
1. Supervisor è¯†åˆ«"å“ª" â†’ ItemAgent
2. ItemAgent è§£æ: item="é’¥åŒ™"
3. æ•°æ®åº“æŸ¥è¯¢:
   - Level 1: normalized_name="é’¥åŒ™" â†’ æ‰¾åˆ°!
   - match_type="exact"
4. æ›´æ–°ç»Ÿè®¡: query_count++, last_accessed_at=now()
5. è¿”å›: "é’¥åŒ™åœ¨æ¡Œä¸Š"

**æŸ¥è¯¢ SQL**:
```sql
SELECT * FROM items
WHERE user_id = 'default'
  AND normalized_name = 'é’¥åŒ™'
  AND is_deleted = 0
```

### åœºæ™¯ 3: æŸ¥è¯¢ç‰©å“ (å…³é”®è¯åŒ¹é…)

**ç”¨æˆ·è¾“å…¥**: "æ‘©æ‰˜è½¦åœ¨å“ªï¼Ÿ"

**å‰ç½®æ¡ä»¶**: æ•°æ®åº“ä¸­æœ‰ "æ‘©æ‰˜è½¦é’¥åŒ™åœ¨è½¦åº“"

**æ‰§è¡Œæµç¨‹**:
1. Supervisor â†’ ItemAgent
2. æ•°æ®åº“æŸ¥è¯¢:
   - Level 1: normalized_name="æ‘©æ‰˜è½¦" â†’ æœªæ‰¾åˆ°
   - Level 2: åˆ«ååŒ¹é… â†’ æœªæ‰¾åˆ°
   - Level 3: FTS5 â†’ æœªæ‰¾åˆ°
   - Level 4: å…³é”®è¯åŒ¹é…
     - extract_keywords("æ‘©æ‰˜è½¦") â†’ ["æ‘©æ‰˜è½¦"]
     - LIKE æŸ¥è¯¢: item_name LIKE "%æ‘©æ‰˜è½¦%"
     - æ‰¾åˆ°: "æ‘©æ‰˜è½¦é’¥åŒ™"
     - éªŒè¯: "æ‘©æ‰˜è½¦" in "æ‘©æ‰˜è½¦é’¥åŒ™" âœ“
     - match_type="keyword_fuzzy"
3. è¿”å›: "æ‰¾åˆ°ç›¸å…³ç‰©å“: æ‘©æ‰˜è½¦é’¥åŒ™åœ¨è½¦åº“"

**æŸ¥è¯¢ SQL**:
```sql
SELECT * FROM items
WHERE user_id = 'default'
  AND is_deleted = 0
  AND (item_name LIKE '%æ‘©æ‰˜è½¦%' OR normalized_name LIKE '%æ‘©æ‰˜è½¦%')
LIMIT 5
```

### åœºæ™¯ 4: æ›´æ–°ç‰©å“ä½ç½®

**ç”¨æˆ·è¾“å…¥**: "é’¥åŒ™åœ¨ä¹¦åŒ…é‡Œ" (ä¹‹å‰è®°å½•çš„æ˜¯"æ¡Œä¸Š")

**æ‰§è¡Œæµç¨‹**:
1. Supervisor â†’ ItemAgent
2. æ•°æ®åº“æ£€æŸ¥: "é’¥åŒ™" å·²å­˜åœ¨
3. ä½ç½®æ¯”è¾ƒ: "ä¹¦åŒ…é‡Œ" â‰  "æ¡Œä¸Š"
4. æ›´æ–°ä½ç½®:
   - location = "ä¹¦åŒ…é‡Œ"
   - moved_at = now()
   - move_count++
5. è®°å½•å†å²:
   - action = "move"
   - old_value = "æ¡Œä¸Š"
   - new_value = "ä¹¦åŒ…é‡Œ"
6. è¿”å›: "é’¥åŒ™å·²ä»æ¡Œä¸Šç§»åŠ¨åˆ°ä¹¦åŒ…é‡Œ"

**æ•°æ®åº“çŠ¶æ€**:
```
items è¡¨:
| id | item_name | location | move_count | moved_at |
|----|-----------|----------|------------|----------|
| 1  | é’¥åŒ™      | ä¹¦åŒ…é‡Œ    | 1          | now()    |

item_history è¡¨:
| id | item_id | action | old_value | new_value |
|----|---------|--------|-----------|-----------|
| 1  | 1       | create | NULL      | æ¡Œä¸Š      |
| 2  | 1       | move   | æ¡Œä¸Š      | ä¹¦åŒ…é‡Œ    |
```

### åœºæ™¯ 5: å¤šè½®å¯¹è¯ (ä¸Šä¸‹æ–‡ç†è§£)

**å¯¹è¯æµç¨‹**:

**ç¬¬ 1 è½®**:
- ç”¨æˆ·: "ä½ å¥½"
- ç³»ç»Ÿ: "ä½ å¥½!æˆ‘æ˜¯ YouYou,å¾ˆé«˜å…´ä¸ºä½ æœåŠ¡ã€‚"
- Session History: [user: "ä½ å¥½", assistant: "ä½ å¥½!..."]

**ç¬¬ 2 è½®**:
- ç”¨æˆ·: "æˆ‘åˆšæ‰è¯´ä»€ä¹ˆäº†ï¼Ÿ"
- Session History åŠ è½½: [ä¹‹å‰çš„å¯¹è¯]
- Supervisor â†’ ChatAgent (å¸¦ä¸Šä¸‹æ–‡)
- ç³»ç»Ÿ: "ä½ åˆšæ‰è¯´'ä½ å¥½'ã€‚"

**ç¬¬ 3 è½®**:
- ç”¨æˆ·: "é’¥åŒ™åœ¨æ¡Œä¸Š"
- Session History: [æ‰€æœ‰å†å² + å½“å‰æ¶ˆæ¯]
- Supervisor â†’ ItemAgent
- ç³»ç»Ÿ: "å·²è®°ä½: é’¥åŒ™åœ¨æ¡Œä¸Š"
- æŒä¹…åŒ–: å¼‚æ­¥å†™å…¥ Zep

### åœºæ™¯ 6: Zep å…œåº•æœç´¢

**å¯¹è¯å†å²** (æœªæ˜ç¡®è®°å½•ä¸ºç‰©å“):
- ç”¨æˆ·: "æˆ‘ä¹‹å‰æåˆ°æ—¶å…‰æœºæ”¾åœ¨å®éªŒå®¤"
- ç³»ç»Ÿ: "å¥½çš„,æˆ‘è®°ä¸‹äº†ã€‚"

**æŸ¥è¯¢**:
- ç”¨æˆ·: "æ—¶å…‰æœºåœ¨å“ªï¼Ÿ"
- æ•°æ®åº“æŸ¥è¯¢ Level 1-4: å…¨éƒ¨å¤±è´¥ (æœªæ˜ç¡®è®°å½•)
- Level 5 Zep æœç´¢:
  ```python
  zep.search_memory(query="ç”¨æˆ·æåˆ° æ—¶å…‰æœº çš„ä½ç½®")
  ```
- Zep è¿”å›: "æˆ‘ä¹‹å‰æåˆ°æ—¶å…‰æœºæ”¾åœ¨å®éªŒå®¤" (score: 0.85)
- ç³»ç»Ÿ: "åœ¨å†å²å¯¹è¯ä¸­æ‰¾åˆ°ç›¸å…³ä¿¡æ¯: æˆ‘ä¹‹å‰æåˆ°æ—¶å…‰æœºæ”¾åœ¨å®éªŒå®¤"

### åœºæ™¯ 7: å¹¶å‘è¯·æ±‚å¤„ç†

**æµ‹è¯•åœºæ™¯**: 5 ä¸ªç”¨æˆ·åŒæ—¶å‘é€è¯·æ±‚

```python
import concurrent.futures

requests = [
    "é’¥åŒ™åœ¨å“ªï¼Ÿ",
    "æ‰‹æœºåœ¨å“ªï¼Ÿ",
    "è®°å½•ç¬”è®°æœ¬åœ¨ä¹¦æˆ¿",
    "ä½ å¥½",
    "åˆ—å‡ºæ‰€æœ‰ç‰©å“"
]

with ThreadPoolExecutor(max_workers=5) as executor:
    futures = [executor.submit(send_message, req) for req in requests]
    results = [f.result() for f in futures]
```

**å…³é”®ç‚¹**:
- SQLite WAL æ¨¡å¼æ”¯æŒå¹¶å‘è¯»
- Session History Manager ä½¿ç”¨çº¿ç¨‹é”
- æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹å¤„ç†,äº’ä¸å¹²æ‰°

---

## è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†

### 1. ç©ºæ¶ˆæ¯

**è¾“å…¥**: ""

**å¤„ç†**:
```python
if not user_input:
    return {"error": "æ¶ˆæ¯ä¸èƒ½ä¸ºç©º"}, 400
```

### 2. è¶…é•¿æ¶ˆæ¯

**è¾“å…¥**: æ•°åƒå­—ç¬¦çš„æ–‡æœ¬

**å¤„ç†**:
- ç³»ç»Ÿèƒ½å¤„ç†,ä¸å´©æºƒ
- LLM å¯èƒ½æˆªæ–­ä¸Šä¸‹æ–‡
- å»ºè®®: æ·»åŠ é•¿åº¦é™åˆ¶ (å¦‚ 5000 å­—ç¬¦)

### 3. ç‰¹æ®Šå­—ç¬¦

**è¾“å…¥**: "æµ‹è¯•ç‰©å“@#$%åœ¨æµ‹è¯•ä½ç½®!!"

**å¤„ç†**:
- `normalize_item_name()` è‡ªåŠ¨å»é™¤æ ‡ç‚¹
- ä¸å½±å“å­˜å‚¨å’ŒæŸ¥è¯¢

### 4. é‡å¤ç‰©å“ç›¸åŒä½ç½®

**è¾“å…¥**: è¿ç»­ä¸¤æ¬¡ "é’¥åŒ™åœ¨æ¡Œä¸Š"

**å¤„ç†**:
- è¯†åˆ«ä¸ºé‡å¤
- ä»…æ›´æ–° last_accessed_at å’Œ query_count
- ä¸å¢åŠ  move_count
- è¿”å›: "é’¥åŒ™ç¡®å®åœ¨æ¡Œä¸Š"

### 5. ä¸å­˜åœ¨çš„ç‰©å“

**è¾“å…¥**: "æ—¶å…‰æœºåœ¨å“ªï¼Ÿ" (æœªè®°å½•)

**å¤„ç†**:
- Level 1-4 æ•°æ®åº“æŸ¥è¯¢å¤±è´¥
- Level 5 Zep æœç´¢ (å¯é€‰)
- è¿”å›: "æ²¡æœ‰æ‰¾åˆ°æ—¶å…‰æœºçš„ä½ç½®è®°å½•"

### 6. ç‰©å“åç§°æ¨¡ç³Š

**è¾“å…¥**: "é‚£ä¸ªä¸œè¥¿åœ¨å“ªï¼Ÿ"

**å¤„ç†**:
- ä¾èµ–ä¸Šä¸‹æ–‡ç†è§£ (Session History)
- ChatAgent å°è¯•è§£æä»£è¯
- å¦‚æœæ— æ³•ç¡®å®š,è¦æ±‚ç”¨æˆ·æ˜ç¡®

### 7. æ•°æ®åº“è¿æ¥å¤±è´¥

**å¤„ç†**:
```python
try:
    db = get_database()
    result = db.query_item(item, user_id)
except Exception as e:
    return {"status": "error", "message": f"æŸ¥è¯¢å¤±è´¥: {str(e)}"}
```

### 8. Zep æœåŠ¡ä¸å¯ç”¨

**å¤„ç†**:
```python
try:
    zep = get_zep_memory()
    memories = zep.search_memory(query)
except Exception as e:
    print(f"Zep æŸ¥è¯¢å¤±è´¥: {e}")
    # é™çº§: ä»…ä½¿ç”¨æ•°æ®åº“ç»“æœ
```

---

## æ€§èƒ½å’Œä¼˜åŒ–

### æ€§èƒ½æŒ‡æ ‡

| æ“ä½œ | é¢„æœŸå“åº”æ—¶é—´ | ç“¶é¢ˆ |
|------|-------------|------|
| è®°å½•ç‰©å“ | < 2s | LLM æ¨ç† |
| æŸ¥è¯¢ç‰©å“ (Level 1) | < 1s | æ•°æ®åº“æŸ¥è¯¢ |
| æŸ¥è¯¢ç‰©å“ (Level 5) | < 5s | Zep æœç´¢ + LLM |
| åˆ—å‡ºç‰©å“ | < 1s | æ•°æ®åº“æŸ¥è¯¢ |
| ä¸€èˆ¬å¯¹è¯ | < 3s | LLM æ¨ç† |

### ä¼˜åŒ–ç­–ç•¥

#### 1. æ•°æ®åº“ä¼˜åŒ–

- âœ… ä½¿ç”¨ç´¢å¼•: `idx_items_user_normalized`, `idx_items_updated_at`
- âœ… WAL æ¨¡å¼: æ”¯æŒå¹¶å‘è¯»å†™
- âœ… FTS5 å…¨æ–‡æœç´¢: é«˜æ•ˆä¸­æ–‡æœç´¢
- ğŸ”® æœªæ¥: æ·»åŠ ç¼“å­˜å±‚ (Redis)

#### 2. ä¼šè¯å†å²ä¼˜åŒ–

- âœ… å†…å­˜ç¼“å­˜: å‡å°‘ Zep è¿œç¨‹è°ƒç”¨
- âœ… å¼‚æ­¥æŒä¹…åŒ–: ä¸é˜»å¡å“åº”
- âœ… è‡ªåŠ¨è£å‰ª: æ§åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦
- ğŸ”® æœªæ¥: æ™ºèƒ½æ‘˜è¦ (ä¿ç•™å…³é”®ä¿¡æ¯)

#### 3. LLM è°ƒç”¨ä¼˜åŒ–

- âœ… temperature=0: æé«˜è·¯ç”±å†³ç­–çš„ç¡®å®šæ€§
- âœ… ç®€æ´æç¤ºè¯: å‡å°‘ token æ¶ˆè€—
- ğŸ”® æœªæ¥: ç¼“å­˜å¸¸è§æŸ¥è¯¢ç»“æœ

#### 4. å¹¶å‘å¤„ç†

- âœ… Flask é»˜è®¤å¤šçº¿ç¨‹
- âœ… SQLite WAL æ¨¡å¼
- âœ… çº¿ç¨‹å®‰å…¨å•ä¾‹æ¨¡å¼
- ğŸ”® æœªæ¥: ä½¿ç”¨ Gunicorn/uWSGI

---

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”

```
           /\
          /  \
         /E2E \        é›†æˆæµ‹è¯• (10%)
        /------\
       /        \
      / API æµ‹è¯• \     API å±‚æµ‹è¯• (30%)
     /------------\
    /              \
   /   å•å…ƒæµ‹è¯•      \   å•å…ƒæµ‹è¯• (60%)
  /------------------\
```

### æµ‹è¯•è¦†ç›–èŒƒå›´

#### 1. å•å…ƒæµ‹è¯• (60%)

**æ•°æ®åº“å±‚** (`core/database.py`):
- `normalize_item_name()` è§„èŒƒåŒ–é€»è¾‘
- `extract_aliases()` åˆ«åæå–
- `extract_keywords()` å…³é”®è¯æå–
- `_verify_item_name()` åç§°éªŒè¯
- å››çº§æŸ¥è¯¢ç­–ç•¥ (Level 1-4)

**è®°å¿†å±‚** (`core/zep_memory.py`, `core/session_history.py`):
- Zep åˆå§‹åŒ–å’Œè¿æ¥
- æ¶ˆæ¯æ·»åŠ å’Œæ£€ç´¢
- ç¼“å­˜æœºåˆ¶

**Agent å±‚**:
- å‚æ•°è§£æ
- å·¥å…·è°ƒç”¨
- å“åº”æå–

#### 2. API æµ‹è¯• (30%)

**ç«¯ç‚¹æµ‹è¯•**:
- `/api/v1/system/health` - å¥åº·æ£€æŸ¥
- `/api/v1/system/config` - é…ç½®ä¿¡æ¯
- `/api/v1/chat/message` - æ ¸å¿ƒå¯¹è¯

**ä¸šåŠ¡åœºæ™¯æµ‹è¯•** (scripts/test_business_logic.py):
- ç‰©å“è®°å½•ã€æŸ¥è¯¢ã€åˆ—è¡¨
- Supervisor è·¯ç”±å†³ç­–
- ChatAgent å¯¹è¯
- ä¼šè¯å†å²ç®¡ç†
- è¾¹ç•Œæƒ…å†µå¤„ç†

#### 3. é›†æˆæµ‹è¯• (10%)

**ç«¯åˆ°ç«¯æµç¨‹**:
- ç”¨æˆ·å®Œæ•´äº¤äº’æµç¨‹
- å¤šè½®å¯¹è¯åœºæ™¯
- å¹¶å‘è¯·æ±‚å¤„ç†
- æ•°æ®ä¸€è‡´æ€§éªŒè¯

### æµ‹è¯•ç”¨ä¾‹è®¾è®¡åŸåˆ™

1. **æ­£å¸¸æµç¨‹ä¼˜å…ˆ**: è¦†ç›–æ ¸å¿ƒä¸šåŠ¡åœºæ™¯
2. **è¾¹ç•Œæƒ…å†µé‡è¦**: ç©ºè¾“å…¥ã€è¶…é•¿è¾“å…¥ã€ç‰¹æ®Šå­—ç¬¦
3. **é”™è¯¯å¤„ç†å¿…æµ‹**: ç½‘ç»œæ•…éšœã€æ•°æ®åº“é”™è¯¯ã€LLM è¶…æ—¶
4. **æ€§èƒ½åŸºå‡†**: å“åº”æ—¶é—´ã€å¹¶å‘èƒ½åŠ›
5. **æ•°æ®ä¸€è‡´æ€§**: æ•°æ®åº“ã€Zepã€å†…å­˜ç¼“å­˜çš„ä¸€è‡´æ€§

### æµ‹è¯•å·¥å…·å’Œæ¡†æ¶

- **å•å…ƒæµ‹è¯•**: pytest
- **API æµ‹è¯•**: requests + è‡ªå®šä¹‰æµ‹è¯•æ¡†æ¶
- **é›†æˆæµ‹è¯•**: ç«¯åˆ°ç«¯è„šæœ¬
- **æ€§èƒ½æµ‹è¯•**: concurrent.futures + time ç»Ÿè®¡

---

## æ€»ç»“

YouYou é¡¹ç›®é‡‡ç”¨äº†ç²¾å¿ƒè®¾è®¡çš„å¤šå±‚æ¶æ„,å®ç°äº†é«˜æ•ˆã€å¯é çš„ç‰©å“ä½ç½®ç®¡ç†å’Œæ™ºèƒ½å¯¹è¯åŠŸèƒ½:

### æ ¸å¿ƒä¼˜åŠ¿

1. **å¤š Agent åä½œ**: Supervisor-Worker æ¨¡å¼,èŒè´£æ¸…æ™°
2. **äº”çº§æŸ¥è¯¢ç­–ç•¥**: ä»ç²¾ç¡®åŒ¹é…åˆ°è¯­ä¹‰æœç´¢,è¦†ç›–å„ç§åœºæ™¯
3. **åŒå±‚è®°å¿†ç³»ç»Ÿ**: å†…å­˜ç¼“å­˜ + Zep æŒä¹…åŒ–,æ€§èƒ½ä¸å¯é æ€§å…¼é¡¾
4. **è‡ªåŠ¨æ³¨å†Œæœºåˆ¶**: Agent å³æ’å³ç”¨,æ˜“äºæ‰©å±•
5. **å®Œå–„çš„é”™è¯¯å¤„ç†**: ä¼˜é›…é™çº§,ä¸å½±å“ç”¨æˆ·ä½“éªŒ

### æŠ€æœ¯äº®ç‚¹

- LangChain 1.0 æœ€æ–° API
- SQLite FTS5 å…¨æ–‡æœç´¢
- Zep 3.0 è®°å¿†ç®¡ç†
- çº¿ç¨‹å®‰å…¨è®¾è®¡
- å¼‚æ­¥æŒä¹…åŒ–

### æµ‹è¯•ç­–ç•¥

- ç»¼åˆæµ‹è¯•è„šæœ¬è¦†ç›–æ‰€æœ‰ä¸šåŠ¡åœºæ™¯
- è¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿
- æ€§èƒ½å’Œå¹¶å‘æµ‹è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-06
**ä½œè€…**: Claude Code
